(function(){function save(k,v){localStorage.setItem(k,JSON.stringify(v));}function load(k,d){const v=localStorage.getItem(k);return v?JSON.parse(v):d;}function round(v){return Math.round(Number(v||0)*100)/100;}window.round=round;window.formatMoney=function(v){return Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});};
if(!localStorage.getItem('tp_seeded')){const users=[{username:'garzon',password:'1234',role:'garzon',name:'Garzón'},{username:'cocina',password:'1234',role:'kitchen',name:'Cocina'},{username:'admin',password:'1234',role:'admin',name:'Administrador'}];const menu=[{id:1,name:'Ceviche Tangoloso',price:8500},{id:2,name:'Lomo Saltado',price:9500},{id:3,name:'Arroz con Mariscos',price:10000},{id:4,name:'Anticuchos (4pcs)',price:6000},{id:5,name:'Chicha Morada',price:2000}];save('tp_users',users);save('tp_menu',menu);save('tp_orders',[]);save('tp_expenses',[]);save('tp_table_changes',[]);const tables=[];for(let i=1;i<=100;i++)tables.push({id:String(i),active:true});save('tp_tables',tables);localStorage.setItem('tp_seeded','1');}
window.loginDemo=function(u,p){const users=load('tp_users',[]);const user=users.find(x=>x.username===u&&x.password===p);if(user){localStorage.setItem('tp_current',JSON.stringify(user));return user;}return null;};window.getCurrentUser=function(){return load('tp_current',null);};window.logout=function(){localStorage.removeItem('tp_current');location.href='index.html';};window.createUserDemo=function(obj){const users=load('tp_users',[]);users.push(obj);save('tp_users',users);};window.getDemoMenu=function(){return load('tp_menu',[]);};window.initTables=function(){const t=[];for(let i=1;i<=100;i++)t.push({id:String(i),active:true});save('tp_tables',t);};window.initTablesSelect=function(id){let tables=load('tp_tables',null);if(!tables){initTables();tables=load('tp_tables');}const sel=document.getElementById(id);if(!sel)return;sel.innerHTML=tables.map(t=>`<option value="${t.id}">${t.id}</option>`).join('');};window.saveOrderDemo=function(order){const orders=load('tp_orders',[]);const id=Date.now();order.id=id;order.table=String(order.table);orders.push(order);save('tp_orders',orders);if(window._subs)window._subs.forEach(cb=>cb(orders));return id;};window.subscribeOrders=function(cb){window._subs=window._subs||[];window._subs.push(cb);cb(load('tp_orders',[]));};window.updateOrderStatusDemo=function(id,status){const orders=load('tp_orders',[]);const o=orders.find(x=>x.id===id);if(o){o.status=status;save('tp_orders',orders);if(window._subs)window._subs.forEach(cb=>cb(orders));}};window.getUnpaidOrdersDemo=function(){return load('tp_orders',[]).filter(o=>!o.paid);};window.changeTableForUser=function(from,to,by){const orders=load('tp_orders',[]);const ord=orders.find(o=>o.table===String(from)&&!o.paid);if(!ord)return false;ord.table=String(to);const changes=load('tp_table_changes',[]);changes.push({from:String(from),to:String(to),by:by,date:Date.now(),orderId:ord.id});save('tp_orders',orders);save('tp_table_changes',changes);if(window._subs)window._subs.forEach(cb=>cb(orders));return true;};window.getTableChangesDemo=function(){return load('tp_table_changes',[]);};window.addExpenseDemo=function(obj){const ex=load('tp_expenses',[]);ex.push(obj);save('tp_expenses',ex);};window.getExpensesDemo=function(){return load('tp_expenses',[]);};window.registerPaymentDemo=function(orderId,paymentsArr){return new Promise((res,rej)=>{const orders=load('tp_orders',[]);const o=orders.find(x=>x.id===orderId);if(!o)return rej(new Error('Pedido no encontrado'));const sum=paymentsArr.reduce((s,p)=>s+Number(p.amount||0),0);if(sum<=0)return rej(new Error('Monto inválido'));o.paid=true;o.payment=paymentsArr;o.paidAt=Date.now();save('tp_orders',orders);if(window._subs)window._subs.forEach(cb=>cb(orders));res(true);});};window.fetchSummaryDemo=function(){const orders=load('tp_orders',[]);const expenses=load('tp_expenses',[]);const paid=orders.filter(o=>o.paid);const totalSales=paid.reduce((s,o)=>s+Number(o.total||0),0);const totalTips=paid.reduce((s,o)=>s+Number(o.tipAmount||0),0);const byMethod={cash:0,debit:0,credit:0,transfer:0};paid.forEach(o=>{if(o.payment)o.payment.forEach(p=>{if(p.method==='cash')byMethod.cash+=Number(p.amount||0);else if(p.method==='debit')byMethod.debit+=Number(p.amount||0);else if(p.method==='credit')byMethod.credit+=Number(p.amount||0);else if(p.method==='transfer')byMethod.transfer+=Number(p.amount||0);});});return{totalOrders:paid.length,totalSales:round(totalSales),totalTips:round(totalTips),byMethod:{cash:round(byMethod.cash),debit:round(byMethod.debit),credit:round(byMethod.credit),transfer:round(byMethod.transfer)}};};
